{% extends "partials/base.html" %}
{% block title %}Projects Dashboard{% endblock title %}
{% block extra_css %}
{% endblock extra_css %}
{% block content %}
    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">

        <div class="page-content">
            <div class="container-fluid">
                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-transparent">
                            <h4 class="mb-sm-0">Projects</h4>

                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboards</a></li>
                                    <li class="breadcrumb-item active" id="time_show">:::</li>
                                </ol>
                            </div>

                        </div>
                    </div>
                </div>
                <!-- end page title -->

                <div class="row project-wrapper">
                    <div class="col-xxl-8">

                        <div class="row">
                            <div class="col-xl-12">
                                <div class="card">
                                    <div class="card-header border-0 align-items-center d-flex">
                                        <h4 class="card-title mb-0 flex-grow-1">Projects Overview</h4>
                                        <div>
                                            <button type="button" class="btn btn-soft-secondary btn-sm">
                                                ALL
                                            </button>
                                            <button type="button" class="btn btn-soft-secondary btn-sm">
                                                1M
                                            </button>
                                            <button type="button" class="btn btn-soft-secondary btn-sm">
                                                6M
                                            </button>
                                            <button type="button" class="btn btn-soft-primary btn-sm">
                                                1Y
                                            </button>
                                        </div>
                                    </div><!-- end card header -->

                                    <div class="card-header p-0 border-0 bg-light-subtle">
                                        <div class="row g-0 text-center">
                                            <div class="col-6 col-sm-3">
                                                <div class="p-3 border border-dashed border-start-0">
                                                    <h5 class="mb-1"><span class="counter-value"
                                                                           data-target="total">0</span>
                                                    </h5>
                                                    <p class="text-muted mb-0">Number of Staff</p>
                                                </div>
                                            </div>
                                            <!--end col-->
                                            <div class="col-6 col-sm-3">
                                                <div class="p-3 border border-dashed border-start-0">
                                                    <h5 class="mb-1"><span class="counter-value"
                                                                           data-target="in_school">0</span>
                                                    </h5>
                                                    <p class="text-muted mb-0">Within school</p>
                                                </div>
                                            </div>
                                            <!--end col-->
                                            <div class="col-6 col-sm-3">
                                                <div class="p-3 border border-dashed border-start-0">
                                                    <h5 class="mb-1"><span class="counter-value"
                                                                           data-target="out_school"></span>
                                                    </h5>
                                                    <p class="text-muted mb-0">Outside school</p>
                                                </div>
                                            </div>
                                            <!--end col-->
                                            <div class="col-6 col-sm-3">
                                                <div class="p-3 border border-dashed border-start-0 border-end-0">
                                                    <h5 class="mb-1 text-success"><span class="counter-value"
                                                                                        data-target="percentage">0</span>
                                                    </h5>
                                                    <p class="text-muted mb-0">Within percentage</p>
                                                </div>
                                            </div>
                                            <!--end col-->
                                        </div>
                                    </div><!-- end card header -->
                                    <img id="videoFeed" src="" alt="test">
                                    {#                                    <img src="{{ url_for("dashboards.video_feed") }}" alt="test">#}
                                    <!-- end card body -->
                                </div><!-- end card -->
                            </div><!-- end col -->
                        </div><!-- end row -->
                    </div><!-- end col -->

                    <div class="col-xxl-4">
                        <div class="table-responsive" style="width: 100%; height: 650px; overflow: auto;">
                            <table class="table align-middle mb-0 table-borderless">
                                <thead class="table-light">
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Identity</th>
                                    <th scope="col">Date</th>
                                    <th scope="col">Status</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td><a class="fw-semibold">VZ2110</a></td>
                                    <td>
                                        <div class="d-flex gap-2 align-items-center">
                                            <div class="flex-shrink-0">
                                                <img src="/static/images/users/avatar-3.jpg" alt=""
                                                     class="avatar-xs rounded-circle"/>
                                            </div>
                                            <div class="flex-grow-1">
                                                Jordan Kennedy
                                            </div>
                                        </div>
                                    </td>
                                    <td>Student</td>
                                    <td>10 Oct, 14:47</td>
                                    <td class="text-success"><i class="ri-checkbox-circle-line fs-17 align-middle"></i>
                                        Paid
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <!-- end table -->
                            <div class="text-center mt-3">
                                <a class="text-success"><i
                                        class="mdi mdi-loading mdi-spin fs-20 align-middle me-2"></i>
                                    Load more </a>
                            </div>
                        </div>

                        <!-- end table responsive -->
                    </div><!-- end col -->
                </div><!-- end row -->


                <div class="row">

                    <div class="col-xl-6" style="width: 100%">
                        <div class="card" style="width: 100%">
                            <div class="card-header">
                                <h4 class="card-title mb-0">Basic Area Chart</h4>
                            </div><!-- end card header -->

                            <div class="card-body" style="width: 100%">
                                <div id="area_chart_basic" data-colors='["--vz-success"]' class="apex-charts"
                                     dir="ltr" style="width: 100%"></div>
                            </div><!-- end card-body -->
                        </div><!-- end card -->
                    </div>
                </div><!-- end row -->

            </div>
            <!-- container-fluid -->
        </div>
        <!-- End Page-content -->

        {% block footer %}
            {% include "partials/footer.html" %}
        {% endblock footer %}
    </div>
    <!-- end main content-->
{% endblock content %}
{% block extra_js %}
    <!-- apexcharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script src="{{ url_for('static' ,filename='libs/apexcharts/dist/apexcharts.min.js') }}"></script>
    <!-- for basic area chart -->
    <script src="https://img.themesbrand.com/velzon/apexchart-js/stock-prices.js"></script>
    <!-- for github style chart -->
    <script src="https://img.themesbrand.com/velzon/apexchart-js/github-data.js"></script>
    <!-- for irregular timeseries chart -->
    <script src="https://img.themesbrand.com/velzon/apexchart-js/irregular-data-series.js"></script>

    {#    <script src="{{ url_for('static' ,filename='libs/moment/moment.js') }}"></script>#}
    {#    <script>#}
    {#        var subjectsData = '{{ subjectsData | tojson | safe }}';#}
    {#    </script>#}

    <!-- areacharts init -->
    <script src="{{ url_for('static' ,filename='js/real_time_area_chart.js') }}"></script>


    <!-- projects js -->
    <script src="{{ url_for('static' ,filename='js/pages/dashboard-projects.init.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            var socket = io.connect(window.location.origin);
            socket.on('connect', function () {
                console.log('Connected to the server');

            });

//   socket.on('connect_error', function (error) {
//       console.log('Connect Error:', error);
////   });

//   socket.on('connect_timeout', function () {
//       console.log('Connection Timeout');
//   });

            function updateFields(data) {
                // 更新"total"字段
                document.querySelector('[data-target="total"]').innerText = data.total;
                // 更新"in_school"字段
                document.querySelector('[data-target="in_school"]').innerText = data.in_school;
                // 更新"out_school"字段
                document.querySelector('[data-target="out_school"]').innerText = data.out_school;
                // 更新"percentage"字段
                document.querySelector('[data-target="percentage"]').innerText = data.percentage + '%';
            }

            function updateTable(updateInfo) {
                var tbody = document.querySelector(".table-responsive tbody");

                // 删除旧的项目
                for (var deletedItem of updateInfo.deleted) {
                    var deletedRow = document.getElementById(deletedItem.ID);
                    if (deletedRow) {
                        deletedRow.remove();
                    }
                }

                // 添加新的项目
                for (var addedItem of updateInfo.added) {
                    var row = tbody.insertRow();
                    row.id = addedItem.ID;
                    row.innerHTML = `<td><a class="fw-semibold">${addedItem.ID}</a></td>
                        <td>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="flex-shrink-0">
                                    <img src="/static/images/users/avatar-3.jpg" alt="" class="avatar-xs rounded-circle" />
                                </div>
                                <div class="flex-grow-1">
                                    ${addedItem.Name}
                                </div>
                            </div>
                        </td>
                        <td>${addedItem.Identity}</td>
                        <td>${addedItem.Date}</td>
                        <td class="text-success"><i class="ri-checkbox-circle-line fs-17 align-middle"></i> ${addedItem.Status}</td>`;
                }
            }

            function updateChart(data) {
                console.log("Received data:", data);  // 打印接收到的数据

                // 合并现有数据和接收到的数据
                for (let key in data) {
                    subjectsData[key] = data[key];
                }

                // 使用完整的 subjectsData 更新 ApexCharts 图表的数据
                chart.updateSeries([{
                    name: "Scores",
                    data: Object.values(subjectsData)
                }]);
                chart.updateOptions({
                    xaxis: {
                        categories: Object.keys(subjectsData)
                    }
                });
            }

            // 通知服务器客户端已准备好接收数据
            socket.emit('client_ready');
            socket.on('video_frame', function (data) {
                console.log("Received video_frame event");

                var image = document.getElementById('videoFeed');
                image.src = "data:image/jpeg;base64," + data;
            });
            socket.on('update_table', function (data) {
                console.log('update_table event received');
                updateTable(data);
            });

//    socket.on('update_field', function (data) {
//        updateFields(data);
//    });
//     socket.on('update_chart', function (data) {
//         updateChart(data);
//     });
        });
    </script>
    <script>
        function updateClock() {
            var now = new Date();
            var time = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds() + '.' + now.getMilliseconds();
            document.getElementById('time_show').innerHTML = time;
            setTimeout(updateClock, 1); // 设置时间间隔为1毫秒
        }

        window.onload = updateClock; // 当页面加载时开始更新时间
    </script>
{% endblock extra_js %}